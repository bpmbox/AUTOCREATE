#!/usr/bin/env python3
"""
ğŸ¯ GitHub Copilotç›´æ¥å›ç­”ã‚·ã‚¹ãƒ†ãƒ 

Supabaseã‹ã‚‰è³ªå•ã‚’å–å¾— â†’ VS Codeãƒãƒ£ãƒƒãƒˆã«ç›´æ¥å…¥åŠ›
OpenAI APIä¸è¦ã€GitHub CopilotãŒç›´æ¥å›ç­”
"""

import os
import time
import json
import pyautogui
import pyperclip
import traceback
from datetime import datetime
from dotenv import load_dotenv

# ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
load_dotenv()

try:
    from supabase import create_client, Client
except ImportError as e:
    print(f"âŒ å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“: {e}")
    print("ğŸ“¦ pip install supabase python-dotenv pyautogui pyperclip")
    exit(1)

class CopilotDirectAnswerSystem:
    def __init__(self):
        print("ğŸš€ GitHub Copilotç›´æ¥å›ç­”ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...")
        
        # ç’°å¢ƒå¤‰æ•°å–å¾—
        self.supabase_url = os.getenv('SUPABASE_URL')
        self.supabase_key = os.getenv('SUPABASE_KEY')
        
        if not all([self.supabase_url, self.supabase_key]):
            print("âŒ ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            return
        
        try:
            # SupabaseåˆæœŸåŒ–
            self.supabase: Client = create_client(self.supabase_url, self.supabase_key)
            print("âœ… Supabaseæ¥ç¶šæˆåŠŸ")
        except Exception as e:
            print(f"âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
            return
        
        # ãƒãƒ£ãƒƒãƒˆåº§æ¨™
        self.chat_coordinates = None
        
        # PyAutoGUIè¨­å®š
        pyautogui.FAILSAFE = True
        pyautogui.PAUSE = 0.2
        
        print("ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†")
    
    def infinite_auto_loop(self, interval=3):
        """ç„¡é™è‡ªå‹•ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Œå…¨ã«æ‰‹ã‚’é›¢ã›ã‚‹ï¼‰"""
        print("ğŸ”¥ ç„¡é™è‡ªå‹•ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰é–‹å§‹!")
        print(f"âš¡ {interval}ç§’é–“éš”ã§æ°¸ç¶šç›£è¦–")
        print("ğŸ¤– æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®Œå…¨è‡ªå‹•ã§å‡¦ç†")
        print("ğŸ“ åº§æ¨™å›ºå®š: (1335, 1045)")
        print("ğŸš€ GitHub CopilotãŒè‡ªå‹•å›ç­”")
        print("="*50)
        
        # åº§æ¨™ã‚’å›ºå®šè¨­å®š
        if not self.chat_coordinates:
            self.chat_coordinates = {'x': 1335, 'y': 1045, 'timestamp': datetime.now().isoformat()}
            print("âœ… åº§æ¨™ã‚’å›ºå®šè¨­å®šã—ã¾ã—ãŸ")
        
        processed_ids = set()
        last_id = 0
        check_count = 0
        success_count = 0
        
        # ç¾åœ¨ã®æœ€æ–°IDã‚’å–å¾—
        try:
            result = self.supabase.table('chat_history') \
                .select('id') \
                .order('id', desc=True) \
                .limit(1) \
                .execute()
            if result.data:
                last_id = result.data[0]['id']
                print(f"ğŸ“Š ç›£è¦–é–‹å§‹ID: {last_id}")
        except Exception as e:
            print(f"âš ï¸ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
        
        print("\nğŸ¯ ç„¡é™ãƒ«ãƒ¼ãƒ—é–‹å§‹ - Ctrl+C ã§åœæ­¢")
        print("="*50)
        
        try:
            while True:  # ç„¡é™ãƒ«ãƒ¼ãƒ—
                check_count += 1
                current_time = datetime.now().strftime('%H:%M:%S')
                
                # å®šæœŸçš„ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
                if check_count % 20 == 1:  # 20å›ã«1å›è©³ç´°è¡¨ç¤º
                    print(f"\nğŸ”„ {current_time} - ãƒã‚§ãƒƒã‚¯ #{check_count} (æˆåŠŸ: {success_count}ä»¶)")
                else:
                    print(f"â° {current_time} #{check_count}", end=" ")
                
                # æœ€æ–°IDã‚ˆã‚Šå¤§ãã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å–å¾—
                try:
                    result = self.supabase.table('chat_history') \
                        .select('*') \
                        .gt('id', last_id) \
                        .order('id', desc=False) \
                        .execute()
                    
                    if result.data:
                        new_messages = result.data
                        print(f"âš¡ æ–°ç€ {len(new_messages)}ä»¶!")
                        
                        for msg in new_messages:
                            owner = msg.get('ownerid', '')
                            message = msg.get('messages', '')
                            msg_id = msg['id']
                            
                            # Copilotç³»ã¯é™¤å¤–
                            if owner and (
                                owner.lower().startswith('copilot') or 
                                owner.lower().startswith('ai-assistant') or
                                owner.lower().startswith('github') or
                                'bot' in owner.lower()
                            ):
                                print(f"  ğŸ¤– Copilotç³»ã‚¹ã‚­ãƒƒãƒ—: {owner}")
                                last_id = max(last_id, msg_id)
                                continue
                            
                            # ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—
                            if not message or not message.strip():
                                print(f"  â­ï¸ ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚­ãƒƒãƒ—")
                                last_id = max(last_id, msg_id)
                                continue
                            
                            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œå‡º
                            question_data = {
                                'id': msg_id,
                                'question': message,
                                'user': owner or 'Unknown',
                                'created': msg.get('created', '')
                            }
                            
                            print(f"\nğŸ¯ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œå‡º!")
                            print(f"ğŸ‘¤ {owner}: {message[:50]}...")
                            
                            # å®Œå…¨è‡ªå‹•ã§Copilotã«è»¢é€
                            if self.post_question_to_chat_auto(question_data):
                                success_count += 1
                                processed_ids.add(msg_id)
                                self.mark_question_as_processed(msg_id)
                                print(f"âœ… è‡ªå‹•è»¢é€æˆåŠŸ! (ç´¯è¨ˆ: {success_count}ä»¶)")
                            else:
                                print("âŒ è»¢é€å¤±æ•—")
                            
                            last_id = max(last_id, msg_id)
                            time.sleep(1)  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–“ã®å¾…æ©Ÿ
                    else:
                        print("ğŸ“­")  # æ–°ç€ãªã—
                        
                except Exception as e:
                    print(f"âŒ ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {e}")
                
                time.sleep(interval)  # æ¬¡ã®ãƒã‚§ãƒƒã‚¯ã¾ã§å¾…æ©Ÿ
                
        except KeyboardInterrupt:
            print(f"\n\nâš ï¸ ç„¡é™è‡ªå‹•ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢")
            print("="*50)
            print(f"ğŸ“Š ç·ãƒã‚§ãƒƒã‚¯å›æ•°: {check_count}")
            print(f"ğŸ¯ è‡ªå‹•å‡¦ç†æˆåŠŸ: {success_count}ä»¶")
            print(f"ğŸ†” æœ€çµ‚å‡¦ç†ID: {last_id}")
            print("âœ¨ ãŠç–²ã‚Œæ§˜ã§ã—ãŸ!")
    
    def post_question_to_chat_auto(self, question_data):
        """è³ªå•ã‚’ãƒãƒ£ãƒƒãƒˆã«è‡ªå‹•æŠ•ç¨¿ï¼ˆç¢ºèªãªã—ã€å®Œå…¨è‡ªå‹•ï¼‰"""
        if not self.chat_coordinates:
            print("âŒ ãƒãƒ£ãƒƒãƒˆåº§æ¨™ãŒæœªè¨­å®š")
            return False
        
        try:
            question = question_data['question']
            user = question_data['user']
            
            # GitHub Copilotã«åˆ†ã‹ã‚Šã‚„ã™ã„è³ªå•å½¢å¼ã«å¤‰æ›
            formatted_question = f"""ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è³ªå•\n\nè³ªå•è€…: {user}\nè³ªå•: {question}\n\nã“ã®å†…å®¹ã§GitHub Issueã‚’ä½œæˆã—ã€å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚å®Ÿè£…çµæœã‚„é€²æ—ã‚’Supabaseã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚\n"""
            
            print(f"ğŸ“¤ Copilotãƒãƒ£ãƒƒãƒˆã«è³ªå•è‡ªå‹•æŠ•ç¨¿ä¸­...")
            print(f"è³ªå•: {question}")
            
            x, y = self.chat_coordinates['x'], self.chat_coordinates['y']
            
            # ãƒãƒ£ãƒƒãƒˆæ¬„ã‚¯ãƒªãƒƒã‚¯
            for i in range(3):
                pyautogui.click(x, y)
                time.sleep(0.3)
            
            # å†…å®¹ã‚¯ãƒªã‚¢
            pyautogui.hotkey('ctrl', 'a')
            time.sleep(0.2)
            pyautogui.press('delete')
            time.sleep(0.3)
            
            # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰çµŒç”±ã§å…¥åŠ›
            pyperclip.copy(formatted_question)
            time.sleep(0.3)
            pyautogui.hotkey('ctrl', 'v')
            time.sleep(1.5)
            
            print("ğŸ“ è³ªå•å…¥åŠ›å®Œäº†")
            
            # è‡ªå‹•é€ä¿¡ï¼ˆç¢ºèªãªã—ï¼‰
            print("ğŸš€ è‡ªå‹•é€ä¿¡ä¸­...")
            pyautogui.press('enter')
            time.sleep(2)
            print("âœ… è³ªå•é€ä¿¡å®Œäº†")
            print("ğŸ’¡ GitHub CopilotãŒå›ç­”ã‚’ç”Ÿæˆä¸­...")
            return True
                
        except Exception as e:
            print(f"âŒ ãƒãƒ£ãƒƒãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def mark_question_as_processed(self, question_id):
        """è³ªå•ã‚’å‡¦ç†æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯"""
        try:
            # ç°¡å˜ãªå‡¦ç†æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
            self.supabase.table('chat_history') \
                .update({'copilot_processed': True}) \
                .eq('id', question_id) \
                .execute()
            return True
        except Exception as e:
            print(f"âš ï¸ å‡¦ç†æ¸ˆã¿ãƒãƒ¼ã‚¯å¤±æ•—: {e}")
            return False

def main():
    import sys
    
    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§è‡ªå‹•èµ·å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
    if len(sys.argv) > 1 and sys.argv[1] == '--auto':
        print("ğŸ”¥ å®Œå…¨è‡ªå‹•èµ·å‹•ãƒ¢ãƒ¼ãƒ‰")
        print("ğŸ“ åº§æ¨™å›ºå®š: (1335, 1045)")
        print("âš¡ 3ç§’é–“éš”ã§æ°¸ç¶šç›£è¦–é–‹å§‹")
        print("ğŸ¤– æ‰‹ã‚’é›¢ã—ã¦ãã ã•ã„ - å®Œå…¨è‡ªå‹•é‹è»¢ä¸­")
        print("-" * 50)
        
        system = CopilotDirectAnswerSystem()
        if hasattr(system, 'supabase') and system.supabase:
            # åº§æ¨™ã‚’è‡ªå‹•è¨­å®š
            system.chat_coordinates = {"x": 1335, "y": 1045}
            print("âœ… åº§æ¨™è‡ªå‹•è¨­å®šå®Œäº†")
            
            # ç„¡é™è‡ªå‹•ãƒ«ãƒ¼ãƒ—ã‚’å³åº§ã«é–‹å§‹
            system.infinite_auto_loop(3)
        else:
            print("âŒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—")
        return
    
    print("ğŸ¯ GitHub Copilotç›´æ¥å›ç­”ã‚·ã‚¹ãƒ†ãƒ ")
    print("æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“")
    print("è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¦ãã ã•ã„:")
    print("python copilot_direct_answer.py --auto")

if __name__ == "__main__":
    main()
