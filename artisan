#!/usr/bin/env python3
"""
ğŸ¨ Artisan - Laravelé¢¨ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ« for Python
=====================================================

Laravel Artisanã‚³ãƒãƒ³ãƒ‰ã‚’Pythonã§å†ç¾
ä¾¿åˆ©ãªCLIãƒ„ãƒ¼ãƒ«ã§é–‹ç™ºåŠ¹ç‡ã‚’å¤§å¹…å‘ä¸Š
"""

import sys
import os
import argparse
import time
import subprocess
import threading
from pathlib import Path
from datetime import datetime
import importlib.util

class ArtisanCommand:
    """Artisané¢¨ã‚³ãƒãƒ³ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.project_root = Path(__file__).parent
        
    def handle(self, *args, **kwargs):
        """ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯"""
        raise NotImplementedError("handle method must be implemented")

class MakeControllerCommand(ArtisanCommand):
    """ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, *args, **kwargs):
        controller_path = self.project_root / "laravel_app" / "Http" / "Controllers" / f"{name}.py"
        controller_content = f'''"""
{name} Controller
=================

Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
"""

from fastapi import APIRouter, Request, HTTPException
from typing import Dict, Any

router = APIRouter()

class {name}:
    """
    {name} Controller
    
    Handle HTTP requests for {name.lower()} related operations
    """
    
    def __init__(self):
        self.router = router
    
    @router.get("/")
    async def index(self) -> Dict[str, Any]:
        """
        Display a listing of the resource
        """
        return {{"message": "Hello from {name}!"}}
    
    @router.post("/")
    async def store(self, request: Request) -> Dict[str, Any]:
        """
        Store a newly created resource
        """
        return {{"message": "Resource created successfully"}}
    
    @router.get("/{{id}}")
    async def show(self, id: int) -> Dict[str, Any]:
        """
        Display the specified resource
        """
        return {{"message": f"Showing resource {{id}}"}}
    
    @router.put("/{{id}}")
    async def update(self, id: int, request: Request) -> Dict[str, Any]:
        """
        Update the specified resource
        """
        return {{"message": f"Resource {{id}} updated successfully"}}
    
    @router.delete("/{{id}}")
    async def destroy(self, id: int) -> Dict[str, Any]:
        """
        Remove the specified resource
        """
        return {{"message": f"Resource {{id}} deleted successfully"}}
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        controller_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(controller_path, 'w', encoding='utf-8') as f:
            f.write(controller_content)
            
        print(f"âœ… Controller created: {controller_path}")
        return True

class MakeModelCommand(ArtisanCommand):
    """ãƒ¢ãƒ‡ãƒ«ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, *args, **kwargs):
        model_path = self.project_root / "laravel_app" / "Models" / f"{name}.py"
        model_content = f'''"""
{name} Model
============

Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
"""

from sqlalchemy import Column, Integer, String, DateTime, Boolean
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.sql import func
from typing import Optional

Base = declarative_base()

class {name}(Base):
    """
    {name} Model
    
    SQLAlchemy model for {name.lower()} table
    """
    
    __tablename__ = "{name.lower()}s"
    
    # Primary Key
    id = Column(Integer, primary_key=True, index=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    # Add your fields here
    # name = Column(String(255), nullable=False)
    # email = Column(String(255), unique=True, index=True)
    # is_active = Column(Boolean, default=True)
    
    def __repr__(self):
        return f"<{name}(id={{self.id}})>"
    
    def to_dict(self):
        """Convert model to dictionary"""
        return {{
            "id": self.id,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
            # Add your fields here
        }}
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        model_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(model_path, 'w', encoding='utf-8') as f:
            f.write(model_content)
            
        print(f"âœ… Model created: {model_path}")
        return True

class MakeServiceCommand(ArtisanCommand):
    """ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, *args, **kwargs):
        service_path = self.project_root / "laravel_app" / "Services" / f"{name}Service.py"
        service_content = f'''"""
{name} Service
==============

Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
"""

from typing import Dict, List, Any, Optional
import asyncio

class {name}Service:
    """
    {name} Service
    
    Business logic for {name.lower()} operations
    """
    
    def __init__(self):
        pass
    
    async def get_all(self) -> List[Dict[str, Any]]:
        """
        Get all {name.lower()} records
        """
        # Implement your logic here
        return []
    
    async def get_by_id(self, id: int) -> Optional[Dict[str, Any]]:
        """
        Get {name.lower()} by ID
        """
        # Implement your logic here
        return None
    
    async def create(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Create new {name.lower()}
        """
        # Implement your logic here
        return {{"message": "{name} created successfully"}}
    
    async def update(self, id: int, data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Update {name.lower()}
        """
        # Implement your logic here
        return {{"message": f"{name} {{id}} updated successfully"}}
    
    async def delete(self, id: int) -> Dict[str, Any]:
        """
        Delete {name.lower()}
        """
        # Implement your logic here
        return {{"message": f"{name} {{id}} deleted successfully"}}
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        service_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(service_path, 'w', encoding='utf-8') as f:
            f.write(service_content)
            
        print(f"âœ… Service created: {service_path}")
        return True

class MakeHybridControllerCommand(ArtisanCommand):
    """ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, controller_type="hybrid", *args, **kwargs):
        if controller_type.lower() == "api":
            base_path = self.project_root / "laravel_app" / "Http" / "Controllers" / "Api"
            parent_class = "FastApiController"
            from_import = "from app.Http.Controllers.Api.FastApiController import FastApiController"
        elif controller_type.lower() == "web":
            base_path = self.project_root / "laravel_app" / "Http" / "Controllers" / "Web"
            parent_class = "WebController"
            from_import = "from app.Http.Controllers.Web.WebController import WebController"
        elif controller_type.lower() == "gradio":
            base_path = self.project_root / "laravel_app" / "Http" / "Controllers" / "Gradio"
            parent_class = "GradioController"
            from_import = "from app.Http.Controllers.Gradio.GradioController import GradioController"
        else:
            base_path = self.project_root / "laravel_app" / "Http" / "Controllers"
            parent_class = "HybridController"
            from_import = "from app.Http.Controllers.HybridController import HybridController"
        
        controller_path = base_path / f"{name}.py"
        controller_content = f'''"""
{name} - Laravelé¢¨ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
Type: {controller_type.upper()}
"""

{from_import}
from fastapi import Request, HTTPException
from typing import Dict, Any
import logging

logger = logging.getLogger(__name__)

class {name}({parent_class}):
    """
    {name} 
    
    Laravelé¢¨ã®{controller_type.upper()}ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
    Django + FastAPI + Gradio çµ±åˆå¯¾å¿œ
    """
    
    def __init__(self):
        super().__init__()
        # ã‚«ã‚¹ã‚¿ãƒ åˆæœŸåŒ–å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ 
        
    async def index(self) -> Dict[str, Any]:
        """
        ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§è¡¨ç¤º
        GET /
        """
        return {{
            "status": "success",
            "data": [
                {{"id": 1, "name": "Sample Resource", "controller": "{name}"}},
            ],
            "message": f"{{self.__class__.__name__}} index called successfully",
            "controller_type": "{controller_type}"
        }}
    
    async def store(self, request: Request) -> Dict[str, Any]:
        """
        æ–°è¦ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
        POST /
        """
        try:
            body = await request.json()
            return {{
                "status": "success",
                "data": {{
                    "id": 999,
                    "created_data": body,
                    "controller": "{name}",
                    "created_at": "{datetime.now().isoformat()}"
                }},
                "message": "Resource created successfully"
            }}
        except Exception as e:
            logger.error(f"Store error in {{self.__class__.__name__}}: {{e}}")
            raise HTTPException(status_code=400, detail=str(e))
    
    async def show(self, id: int) -> Dict[str, Any]:
        """
        ç‰¹å®šãƒªã‚½ãƒ¼ã‚¹è¡¨ç¤º
        GET /{{id}}
        """
        return {{
            "status": "success",
            "data": {{
                "id": id,
                "name": f"Resource {{id}}",
                "controller": "{name}",
                "type": "{controller_type}_resource"
            }},
            "message": f"Resource {{id}} retrieved successfully"
        }}
    
    async def update(self, id: int, request: Request) -> Dict[str, Any]:
        """
        ãƒªã‚½ãƒ¼ã‚¹æ›´æ–°
        PUT /{{id}}
        """
        try:
            body = await request.json()
            return {{
                "status": "success",
                "data": {{
                    "id": id,
                    "updated_data": body,
                    "controller": "{name}",
                    "updated_at": "{datetime.now().isoformat()}"
                }},
                "message": f"Resource {{id}} updated successfully"
            }}
        except Exception as e:
            logger.error(f"Update error in {{self.__class__.__name__}}: {{e}}")
            raise HTTPException(status_code=400, detail=str(e))
    
    async def destroy(self, id: int) -> Dict[str, Any]:
        """
        ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
        DELETE /{{id}}
        """
        return {{
            "status": "success",
            "data": {{
                "id": id,
                "controller": "{name}",
                "deleted_at": "{datetime.now().isoformat()}"
            }},
            "message": f"Resource {{id}} deleted successfully"
        }}'''

        if controller_type.lower() == "gradio":
            controller_content += f'''
    
    def gradio_process(self, input_text: str) -> str:
        """
        Gradio å‡¦ç†é–¢æ•°
        """
        try:
            # ã‚«ã‚¹ã‚¿ãƒ å‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…
            processed_result = f"{{self.__class__.__name__}} processed: {{input_text}}"
            return processed_result
        except Exception as e:
            logger.error(f"Gradio processing error: {{e}}")
            return f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {{e}}"'''

        controller_content += f'''

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
# {name.lower()}_instance = {name}()
# router = {name.lower()}_instance.router  # FastAPIç”¨
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        controller_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(controller_path, 'w', encoding='utf-8') as f:
            f.write(controller_content)
            
        print(f"âœ… {controller_type.upper()} Controller created: {controller_path}")
        print(f"ğŸ“ Location: {controller_path.relative_to(self.project_root)}")
        print(f"ğŸ¯ Type: {controller_type.upper()} (Django + FastAPI + Gradio compatible)")
        return True

class ServeCommand(ArtisanCommand):
    """é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, port=8000, host="0.0.0.0", *args, **kwargs):
        import subprocess
        print(f"ğŸš€ Starting development server on {host}:{port}")
        try:
            subprocess.run([
                "uvicorn", 
                "core.app:app", 
                "--host", str(host), 
                "--port", str(port), 
                "--reload"
            ])
        except KeyboardInterrupt:
            print("\nğŸ‘‹ Server stopped")

class ListRoutesCommand(ArtisanCommand):
    """ãƒ«ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤ºã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, *args, **kwargs):
        print("ğŸ›£ï¸  Application Routes:")
        print("+" + "-" * 50 + "+")
        print("| Method | URI | Controller |")
        print("+" + "-" * 50 + "+")
        
        # ãƒ«ãƒ¼ãƒˆæƒ…å ±ã‚’å‹•çš„ã«å–å¾—ï¼ˆå®Ÿè£…ãŒå¿…è¦ï¼‰
        routes = [
            ("GET", "/", "HomeController@index"),
            ("GET", "/api/health", "HealthController@check"),
        ]
        
        for method, uri, controller in routes:
            print(f"| {method:<6} | {uri:<15} | {controller:<20} |")
        
        print("+" + "-" * 50 + "+")

class ProjectInfoCommand(ArtisanCommand):
    """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤ºã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, *args, **kwargs):
        print("ğŸ—ï¸  Laravelæ§‹é€ å¯¾å¿œ Django+FastAPI+Gradio ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ")
        print("=" * 60)
        print(f"ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ: {self.project_root}")
        print(f"ğŸš€ ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ: app.py (Hugging Face Spacesäº’æ›)")
        print(f"âš™ï¸  ASGIè¨­å®š: mysite/asgi.py")
        print(f"ğŸ”§ ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—: bootstrap/app.py")
        print()
        
        # Laravelæ§‹é€ ã®ç¢ºèª
        laravel_dirs = [
            "laravel_app/Http/Controllers/Api",
            "laravel_app/Http/Controllers/Web", 
            "laravel_app/Http/Controllers/Gradio",
            "laravel_app/Services",
            "laravel_app/Models",
            "laravel_app/Console",
            "routes",
            "bootstrap"
        ]
        
        print("ğŸ“‚ Laravelæ§‹é€ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:")
        for directory in laravel_dirs:
            dir_path = self.project_root / directory
            status = "âœ…" if dir_path.exists() else "âŒ"
            print(f"   {status} {directory}")
        
        print()
        print("ğŸ”— ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆè¨­å®š:")
        print("   â€¢ Hugging Face Spaces: app.py")
        print("   â€¢ ASGI ã‚µãƒ¼ãƒãƒ¼: app:app")
        print("   â€¢ Django ASGI: mysite.asgi:app")
        print("   â€¢ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼: python bootstrap/app.py")
        print()
        
        # Laravelé¢¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºèª
        routes_files = [
            "routes/web.py",
            "routes/api.py", 
            "routes/polls.py",
            "routes/hybrid.py",
            "routes/laravel_routes.py"
        ]
        
        print("ğŸ”— Laravelé¢¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:")
        for route_file in routes_files:
            route_path = self.project_root / route_file
            status = "âœ…" if route_path.exists() else "âŒ"
            print(f"   {status} {route_file}")
        
        print()
        print("ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:")
        print("   â€¢ / - Web Routes (Laravelé¢¨)")
        print("   â€¢ /api/v1/ - API Routes (Laravelé¢¨)")
        print("   â€¢ /api/polls/ - Polls API")
        print("   â€¢ /hybrid/ - Hybrid Routes")
        print("   â€¢ /django/admin/ - Djangoç®¡ç†ç”»é¢")

class GradioTestCommand(ArtisanCommand):
    """Gradioæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰"""
    
    def __init__(self):
        super().__init__()
        self.base_url = "http://localhost:7860"
        self.gradio_functions = self._discover_gradio_functions()
    
    def _discover_gradio_functions(self):
        """controllers/ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰Gradioæ©Ÿèƒ½ã‚’è‡ªå‹•ç™ºè¦‹"""
        gradio_functions = {}
        controllers_path = self.project_root / "controllers"
        
        if not controllers_path.exists():
            return gradio_functions
            
        for item in controllers_path.iterdir():
            if item.is_dir() and item.name.startswith("gra_"):
                # gra_01_chat -> chat
                function_name = item.name.split("_", 2)[-1] if "_" in item.name else item.name
                gradio_functions[function_name] = {
                    "path": item,
                    "name": function_name,
                    "directory": item.name
                }
        
        return gradio_functions
    
    def handle(self, function_name=None, verbose=False, fix=False, *args, **kwargs):
        """Gradioãƒ†ã‚¹ãƒˆã®ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
        print("ğŸ§ª Gradioæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹...")
        print(f"ğŸ“¡ ãƒ†ã‚¹ãƒˆå¯¾è±¡URL: {self.base_url}")
        print("=" * 50)
        
        if function_name:
            # å€‹åˆ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            result = self._test_single_function(function_name, verbose, fix)
            return result
        else:
            # å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            return self._test_all_functions(verbose, fix)
    
    def _test_single_function(self, function_name, verbose=False, fix=False):
        """å˜ä¸€Gradioæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
        if function_name not in self.gradio_functions:
            print(f"âŒ æ©Ÿèƒ½ '{function_name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            print(f"ğŸ” åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½: {list(self.gradio_functions.keys())}")
            return False
            
        function_info = self.gradio_functions[function_name]
        print(f"ğŸ§ª {function_name} æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆä¸­...")
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        result = self._run_gradio_test(function_info, verbose)
        
        if not result and fix:
            print(f"ğŸ”§ {function_name} ã®è‡ªå‹•ä¿®æ­£ã‚’è©¦è¡Œä¸­...")
            self._attempt_fix(function_info)
            
        return result
    
    def _test_all_functions(self, verbose=False, fix=False):
        """å…¨Gradioæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
        results = {}
        total_functions = len(self.gradio_functions)
        passed_functions = 0
        
        for function_name, function_info in self.gradio_functions.items():
            print(f"ğŸ§ª {function_name} æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆä¸­...")
            result = self._run_gradio_test(function_info, verbose)
            results[function_name] = result
            
            if result:
                passed_functions += 1
            elif fix:
                print(f"ğŸ”§ {function_name} ã®è‡ªå‹•ä¿®æ­£ã‚’è©¦è¡Œä¸­...")
                self._attempt_fix(function_info)
        
        # çµæœè¡¨ç¤º
        print("=" * 50)
        print(f"âœ… ãƒ†ã‚¹ãƒˆå®Œäº†: {passed_functions}/{total_functions} æ©Ÿèƒ½ãŒæˆåŠŸ")
        if verbose:
            for function_name, result in results.items():
                status = "âœ…" if result else "âŒ"
                print(f"  {status} {function_name}")
        
        return passed_functions == total_functions

class RouteListCommand(ArtisanCommand):
    """ãƒ«ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤ºã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, *args, **kwargs):
        """ãƒ«ãƒ¼ãƒˆä¸€è¦§ã‚’è¡¨ç¤º"""
        print("ğŸ›£ï¸  ãƒ«ãƒ¼ãƒˆä¸€è¦§")
        print("=" * 50)
        
        # FastAPIãƒ«ãƒ¼ãƒˆã®æ¤œå‡º
        self._scan_fastapi_routes()
        
        # Gradioãƒ«ãƒ¼ãƒˆã®æ¤œå‡º
        self._scan_gradio_routes()
        
        # Djangoãƒ«ãƒ¼ãƒˆã®æ¤œå‡ºï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
        self._scan_django_routes()
        
        return True
    
    def _scan_fastapi_routes(self):
        """FastAPIãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢"""
        print("\nğŸ“ FastAPI Routes:")
        print("-" * 30)
        
        try:
            # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            app_files = [
                "app.py",
                "main.py", 
                "app_*.py"
            ]
            
            for app_file in app_files:
                app_path = self.project_root / app_file
                if app_path.exists():
                    print(f"ğŸ“ {app_file}:")
                    self._analyze_fastapi_file(app_path)
                    
            # routersãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¹ã‚­ãƒ£ãƒ³
            routers_dir = self.project_root / "routers"
            if routers_dir.exists():
                print(f"\nğŸ“ routers/:")
                for router_file in routers_dir.glob("**/*.py"):
                    if router_file.name != "__init__.py":
                        print(f"  ğŸ“„ {router_file.relative_to(self.project_root)}")
                        self._analyze_router_file(router_file)
                        
        except Exception as e:
            print(f"âŒ FastAPIãƒ«ãƒ¼ãƒˆæ¤œå‡ºã‚¨ãƒ©ãƒ¼: {e}")
    
    def _scan_gradio_routes(self):
        """Gradioãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢"""
        print("\nğŸ¨ Gradio Interfaces:")
        print("-" * 30)
        
        try:
            # routersãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®gradioé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
            routers_dir = self.project_root / "routers"
            if routers_dir.exists():
                gradio_files = list(routers_dir.glob("**/gra_*/*.py"))
                
                for gradio_file in gradio_files:
                    if gradio_file.name != "__init__.py":
                        interface_name = gradio_file.parent.name
                        print(f"  ğŸ¯ {interface_name}: {gradio_file.name}")
                        self._analyze_gradio_file(gradio_file)
                        
        except Exception as e:
            print(f"âŒ Gradioãƒ«ãƒ¼ãƒˆæ¤œå‡ºã‚¨ãƒ©ãƒ¼: {e}")
    
    def _scan_django_routes(self):
        """Djangoãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢"""
        print("\nğŸ Django URLs:")
        print("-" * 30)
        
        try:
            # urls.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
            urls_files = list(self.project_root.glob("**/urls.py"))
            
            if urls_files:
                for urls_file in urls_files:
                    print(f"  ğŸ“„ {urls_file.relative_to(self.project_root)}")
                    self._analyze_django_urls(urls_file)
            else:
                print("  â„¹ï¸  Django URLsãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                
        except Exception as e:
            print(f"âŒ DjangoURLæ¤œå‡ºã‚¨ãƒ©ãƒ¼: {e}")
    
    def _analyze_fastapi_file(self, file_path):
        """FastAPIãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # @app.get, @app.post ãªã©ã‚’æ¤œç´¢
            import re
            routes = re.findall(r'@app\.(get|post|put|delete|patch)\(["\']([^"\']+)["\']', content)
            
            for method, path in routes:
                print(f"    {method.upper():<6} {path}")
                
        except Exception as e:
            print(f"    âŒ è§£æã‚¨ãƒ©ãƒ¼: {e}")
    
    def _analyze_router_file(self, file_path):
        """ãƒ«ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # @router.get, @router.post ãªã©ã‚’æ¤œç´¢
            import re
            routes = re.findall(r'@router\.(get|post|put|delete|patch)\(["\']([^"\']+)["\']', content)
            
            if routes:
                for method, path in routes:
                    print(f"    {method.upper():<6} {path}")
            else:
                # é–¢æ•°å®šç¾©ã‚’æ¤œç´¢
                functions = re.findall(r'def ([a-zA-Z_][a-zA-Z0-9_]*)\(', content)
                if functions:
                    print(f"    ğŸ“ Functions: {', '.join(functions[:5])}")
                    
        except Exception as e:
            print(f"    âŒ è§£æã‚¨ãƒ©ãƒ¼: {e}")
    
    def _analyze_gradio_file(self, file_path):
        """Gradioãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # gr.Interface, gr.Blocks, gr.TabbedInterface ã‚’æ¤œç´¢
            import re
            interfaces = re.findall(r'gr\.(Interface|Blocks|TabbedInterface)', content)
            functions = re.findall(r'def ([a-zA-Z_][a-zA-Z0-9_]*)\(', content)
            
            if interfaces:
                print(f"      ğŸ¨ Gradio Type: {', '.join(set(interface for interface in interfaces))}")
            if functions:
                print(f"      ğŸ“ Functions: {', '.join(functions[:3])}")
                
        except Exception as e:
            print(f"    âŒ è§£æã‚¨ãƒ©ãƒ¼: {e}")
    
    def _analyze_django_urls(self, file_path):
        """Django URLsãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # path() ã‚„ url() ã‚’æ¤œç´¢
            import re
            paths = re.findall(r'path\(["\']([^"\']+)["\']', content)
            
            for path in paths:
                print(f"    PATH   {path}")
                
        except Exception as e:
            print(f"    âŒ è§£æã‚¨ãƒ©ãƒ¼: {e}")

class GradioListCommand(ArtisanCommand):
    """Gradioæ©Ÿèƒ½ä¸€è¦§è¡¨ç¤ºã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, *args, **kwargs):
        """Gradioæ©Ÿèƒ½ä¸€è¦§ã‚’è¡¨ç¤º"""
        print("ğŸ¨ Gradioæ©Ÿèƒ½ä¸€è¦§")
        print("=" * 50)
        
        try:
            routers_dir = self.project_root / "routers"
            if not routers_dir.exists():
                print("âŒ routersãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                return False
                
            gradio_modules = []
            
            # gra_ã§å§‹ã¾ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¤œç´¢
            for item in routers_dir.iterdir():
                if item.is_dir() and item.name.startswith('gra_'):
                    gradio_modules.append(item)
            
            if not gradio_modules:
                print("â„¹ï¸  Gradioæ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                return True
                
            for i, module_dir in enumerate(gradio_modules, 1):
                module_name = module_dir.name
                print(f"\n{i}. ğŸ“ {module_name}")
                
                # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã®Pythonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
                py_files = list(module_dir.glob("*.py"))
                if py_files:
                    for py_file in py_files:
                        if py_file.name != "__init__.py":
                            print(f"   ğŸ“„ {py_file.name}")
                            self._analyze_gradio_functionality(py_file)
                else:
                    print("   â„¹ï¸  Pythonãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                    
            return True
            
        except Exception as e:
            print(f"âŒ Gradioæ©Ÿèƒ½ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def _analyze_gradio_functionality(self, file_path):
        """Gradioæ©Ÿèƒ½ã‚’è§£æ"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # Gradioé–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢
            import re
            
            # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç¨®é¡
            interfaces = re.findall(r'gr\.(Interface|Blocks|TabbedInterface|ChatInterface)', content)
            if interfaces:
                print(f"      ğŸ¯ Type: {', '.join(set(interfaces))}")
            
            # å…¥åŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            inputs = re.findall(r'gr\.(Textbox|Button|Slider|Dropdown|FileUpload|Image|Audio)', content)
            if inputs:
                print(f"      ğŸ“¥ Inputs: {', '.join(set(inputs))}")
            
            # å‡ºåŠ›ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            outputs = re.findall(r'outputs?=.*?gr\.(Textbox|Image|Audio|Video|HTML|Markdown)', content)
            if outputs:
                print(f"      ğŸ“¤ Outputs: {len(outputs)} components")
                
        except Exception as e:
            print(f"      âŒ è§£æã‚¨ãƒ©ãƒ¼: {e}")

class MakeMigrationCommand(ArtisanCommand):
    """ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, *args, **kwargs):
        migration_path = self.project_root / "database" / "migrations" / f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{name}.py"
        migration_content = f'''"""
{name} Migration
================

Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
"""

import sqlite3
import os
from datetime import datetime

def up():
    """
    Run the migration
    """
    db_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'database.db')
    
    with sqlite3.connect(db_path) as conn:
        cursor = conn.cursor()
        
        # Example: Create table migration
        create_table_sql = """
            CREATE TABLE IF NOT EXISTS example_table (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                email TEXT UNIQUE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """
        cursor.execute(create_table_sql)
        
        conn.commit()
        print(f"âœ… Migration {name} executed successfully")

def down():
    """
    Reverse the migration
    """
    db_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'database.db')
    
    with sqlite3.connect(db_path) as conn:
        cursor = conn.cursor()
        
        # Example: Drop table migration
        cursor.execute('DROP TABLE IF EXISTS example_table')
        
        conn.commit()
        print(f"âœ… Migration {name} rolled back successfully")

if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1 and sys.argv[1] == "down":
        down()
    else:
        up()
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        migration_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(migration_path, 'w', encoding='utf-8') as f:
            f.write(migration_content)
            
        print(f"âœ… Migration created: {migration_path}")
        return True

class ActiveRouteListCommand(ArtisanCommand):
    """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ«ãƒ¼ãƒˆã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, *args, **kwargs):
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ«ãƒ¼ãƒˆä¸€è¦§ã®ã¿ã‚’è¡¨ç¤º"""
        print("ğŸ›£ï¸  ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ«ãƒ¼ãƒˆä¸€è¦§")
        print("=" * 50)
        print("â€» å®Ÿéš›ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒˆã®ã¿è¡¨ç¤º")
        
        # FastAPIãƒ«ãƒ¼ãƒˆã®æ¤œå‡ºï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿ï¼‰
        self._scan_active_fastapi_routes()
        
        # Gradioãƒ«ãƒ¼ãƒˆã®æ¤œå‡ºï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿ï¼‰
        self._scan_active_gradio_routes()
        
        # Djangoãƒ«ãƒ¼ãƒˆã®æ¤œå‡ºï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿ï¼‰
        self._scan_active_django_routes()
        
        return True
    
    def _scan_active_fastapi_routes(self):
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªFastAPIãƒ«ãƒ¼ãƒˆã®ã¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³"""
        print("\nğŸ“ Active FastAPI Routes:")
        print("-" * 30)
        
        # mysite/asgi.pyãŒãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
        asgi_path = self.project_root / "mysite" / "asgi.py"
        if asgi_path.exists():
            print("ğŸ“ mysite/asgi.py:")
            self._extract_routes_from_file(asgi_path)
        
        # app.pyã¨main.pyï¼ˆHugging Face Spacesç”¨ï¼‰
        main_files = ["app.py", "main.py"]
        for main_file in main_files:
            main_path = self.project_root / main_file
            if main_path.exists():
                print(f"ğŸ“ {main_file}:")
                self._extract_routes_from_file(main_path)
        
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªroutersã®ã¿ï¼ˆworkspaceã¯é™¤å¤–ï¼‰
        routers_dir = self.project_root / "routers"
        if routers_dir.exists():
            print(f"\nğŸ“ routers/ (active only):")
            # ç›´æ¥ã®Pythonãƒ•ã‚¡ã‚¤ãƒ«
            for py_file in routers_dir.glob("*.py"):
                if py_file.name not in ["__init__.py"]:
                    relative_path = py_file.relative_to(self.project_root)
                    print(f"  ğŸ“„ {relative_path}")
                    self._extract_routes_from_file(py_file)
            
            # gra_*ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰
            for subdir in routers_dir.iterdir():
                if subdir.is_dir() and subdir.name.startswith('gra_'):
                    for py_file in subdir.glob("*.py"):
                        if py_file.name not in ["__init__.py"]:
                            relative_path = py_file.relative_to(self.project_root)
                            print(f"  ğŸ“„ {relative_path}")
                            self._extract_gradio_functions(py_file)
    
    def _scan_active_gradio_routes(self):
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªGradioã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ã¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³"""
        print("\nğŸ¨ Active Gradio Interfaces:")
        print("-" * 30)
        
        # controllers/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå®Ÿéš›ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‚‚ã®ï¼‰
        controllers_dir = self.project_root / "controllers"
        if controllers_dir.exists():
            for subdir in controllers_dir.iterdir():
                if subdir.is_dir() and subdir.name.startswith('gra_'):
                    print(f"  ğŸ¯ {subdir.name}: ", end="")
                    
                    py_files = [f for f in subdir.glob("*.py") if f.name != "__init__.py"]
                    if py_files:
                        main_file = py_files[0]  # æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»£è¡¨ã¨ã—ã¦
                        print(f"{main_file.name}")
                        self._analyze_gradio_interface(main_file)
                    else:
                        print("No Python files")
    
    def _scan_active_django_routes(self):
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªDjangoURLã®ã¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³"""
        print("\nğŸ Active Django URLs:")
        print("-" * 30)
        
        # mysite/urls.pyã‚’ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦ç¢ºèª
        main_urls = self.project_root / "mysite" / "urls.py"
        if main_urls.exists():
            print(f"  ğŸ“„ mysite/urls.py")
            self._extract_django_patterns(main_urls)
        
        # polls/urls.pyï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰
        polls_urls = self.project_root / "polls" / "urls.py"
        if polls_urls.exists():
            print(f"  ğŸ“„ polls/urls.py")
            self._extract_django_patterns(polls_urls)
    
    def _extract_routes_from_file(self, file_path):
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ«ãƒ¼ãƒˆã‚’æŠ½å‡º"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            import re
            
            # FastAPI ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ«ãƒ¼ãƒˆ
            route_patterns = [
                r'@app\.(get|post|put|delete|patch)\(["\']([^"\']+)["\']',
                r'@router\.(get|post|put|delete|patch)\(["\']([^"\']+)["\']'
            ]
            
            routes_found = []
            for pattern in route_patterns:
                matches = re.findall(pattern, content)
                for method, path in matches:
                    routes_found.append((method.upper(), path))
            
            if routes_found:
                for method, path in routes_found:
                    print(f"    {method:<6} {path}")
            
        except Exception as e:
            print(f"    âŒ Error reading {file_path}: {e}")
    
    def _extract_gradio_functions(self, file_path):
        """Gradioãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Gradioé–¢æ•°ã‚’æŠ½å‡º"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            import re
            
            # ä¸€èˆ¬çš„ãªé–¢æ•°å®šç¾©ã‚’æ¤œç´¢
            function_pattern = r'def\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\('
            functions = re.findall(function_pattern, content)
            
            # __ã§å§‹ã¾ã‚‹å†…éƒ¨é–¢æ•°ã‚„ç‰¹æ®Šãƒ¡ã‚½ãƒƒãƒ‰ã‚’é™¤å¤–
            user_functions = [f for f in functions if not f.startswith('_')]
            
            if user_functions:
                print(f"    ğŸ“ Functions: {', '.join(user_functions)}")
        except Exception as e:
            print(f"    âŒ Error reading gradio file: {e}")
    
    def _analyze_gradio_interface(self, file_path):
        """Gradioã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’è§£æ"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            import re
            
            # Gradioã‚¿ã‚¤ãƒ—ã‚’æ¤œå‡º
            gradio_types = re.findall(r'gr\.(Interface|Blocks|TabbedInterface|ChatInterface)', content)
            if gradio_types:
                print(f"      ğŸ¨ Gradio Type: {', '.join(set(gradio_types))}")
            
            # é–¢æ•°å®šç¾©ã‚’æ¤œå‡º
            functions = re.findall(r'def\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\(', content)
            user_functions = [f for f in functions if not f.startswith('_')]
            if user_functions:
                print(f"      ğŸ“ Functions: {', '.join(user_functions)}")
                
        except Exception as e:
            print(f"      âŒ Analysis error: {e}")
    
    def _extract_django_patterns(self, file_path):
        """Djangoã®URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            import re
            
            # Django URL ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
            patterns = [
                r'path\(["\']([^"\']*)["\']',
                r'url\(["\']([^"\']*)["\']'
            ]
            
            urls_found = []
            for pattern in patterns:
                matches = re.findall(pattern, content)
                urls_found.extend(matches)
            
            if urls_found:
                for url in urls_found:
                    print(f"    PATH   {url}")
            
        except Exception as e:
            print(f"    âŒ Error reading Django URLs: {e}")

class CICDCommand(ArtisanCommand):
    """CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†ã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, action="test", *args, **kwargs):
        """CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"""
        print(f"ğŸš€ CI/CD Pipeline - {action.upper()}")
        print("=" * 50)
        
        if action == "test":
            return self._run_tests()
        elif action == "routes":
            return self._check_routes()
        elif action == "gradio":
            return self._test_gradio()
        elif action == "full":
            return self._run_full_pipeline()
        else:
            print(f"âŒ Unknown action: {action}")
            print("Available actions: test, routes, gradio, full")
            return False
    
    def _run_tests(self):
        """åŸºæœ¬ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"""
        print("ğŸ§ª Running basic tests...")
        
        try:
            # ãƒ«ãƒ¼ãƒˆAPIãƒ†ã‚¹ãƒˆ
            from routers.route_api import scanner
            active_routes = scanner.scan_active_routes()
            
            print(f"âœ… Route Scanner: OK")
            print(f"ğŸ“ FastAPI Routes: {len(active_routes.get('fastapi_routes', []))}")
            print(f"ğŸ¨ Gradio Interfaces: {len(active_routes.get('gradio_interfaces', []))}")
            print(f"ğŸ Django URLs: {len(active_routes.get('django_urls', []))}")
            
            return True
            
        except Exception as e:
            print(f"âŒ Test failed: {e}")
            return False
    
    def _check_routes(self):
        """ãƒ«ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯"""
        print("ğŸ›£ï¸ Checking routes...")
        
        try:
            from routers.route_api import scanner
            
            all_routes = scanner.scan_all_routes()
            active_routes = scanner.scan_active_routes()
            
            all_total = all_routes.get('summary', {}).get('total_routes', 0)
            active_total = active_routes.get('summary', {}).get('total_routes', 0)
            
            print(f"ğŸ“Š Total Routes: {all_total}")
            print(f"ğŸ¯ Active Routes: {active_total}")
            
            if active_total > 0:
                ratio = (active_total / all_total) * 100 if all_total > 0 else 0
                print(f"ğŸ“ˆ Active Ratio: {ratio:.1f}%")
            
            return True
            
        except Exception as e:
            print(f"âŒ Route check failed: {e}")
            return False
    
    def _test_gradio(self):
        """Gradioãƒ†ã‚¹ãƒˆ"""
        print("ğŸ¨ Testing Gradio interfaces...")
        
        try:
            from app.Http.Controllers.GradioController import GradioController
            controller = GradioController()
            interface_info = controller.get_interface_list()
            
            total_interfaces = interface_info.get('total_count', 0)
            print(f"âœ… Gradio Controller: OK")
            print(f"ğŸ¨ Total Interfaces: {total_interfaces}")
            
            if total_interfaces > 0:
                print("ğŸ“ Interface Names:")
                for name in interface_info.get('interface_names', [])[:5]:
                    print(f"   â€¢ {name}")
                if total_interfaces > 5:
                    print(f"   ... and {total_interfaces - 5} more")
            
            return True
            
        except Exception as e:
            print(f"âŒ Gradio test failed: {e}")
            return False
    
    def _run_full_pipeline(self):
        """ãƒ•ãƒ«CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ"""
        print("ğŸ”„ Running full CI/CD pipeline...")
        
        results = {
            "routes": self._check_routes(),
            "gradio": self._test_gradio(),
            "tests": self._run_tests()
        }
        
        passed = sum(results.values())
        total = len(results)
        
        print("\nğŸ“Š Pipeline Results:")
        print("-" * 30)
        for test, result in results.items():
            status = "âœ… PASS" if result else "âŒ FAIL"
            print(f"  {status} {test.capitalize()}")
        
        print(f"\nğŸ¯ Overall: {passed}/{total} tests passed")
        
        if passed == total:
            print("ğŸ‰ All tests passed! Pipeline successful.")
            return True
        else:
            print("âš ï¸ Some tests failed. Check the issues above.")
            return False

class TestCommand(ArtisanCommand):
    """ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ - Laravelé¢¨ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
    
    def handle(self, test_type=None, *args, **kwargs):
        """ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯"""
        print("ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...")
        
        if test_type == "copilot":
            self.test_copilot_automation()
        elif test_type == "unit":
            self.run_unit_tests()
        elif test_type == "feature":
            self.run_feature_tests()
        elif test_type == "all":
            self.run_all_tests()
        else:
            self.run_all_tests()
    
    def test_copilot_automation(self):
        """Copilotè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ"""
        print("ğŸ¤– Copilotè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...")
        
        try:
            # Copilotè‡ªå‹•åŒ–ã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            sys.path.append(str(self.project_root / "app" / "Console" / "Commands"))
            
            from copilot_github_cli_automation import GitHubCopilotAutomation
            
            # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§åˆæœŸåŒ–
            automation = GitHubCopilotAutomation(offline_mode=True)
            
            # åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            print("ğŸ“‹ 1. åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ...")
            assert automation is not None, "åˆæœŸåŒ–ã«å¤±æ•—"
            print("âœ… åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆå®Œäº†")
            
            # åº§æ¨™èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
            print("ğŸ“‹ 2. åº§æ¨™èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ...")
            coords = automation.load_coordinates()
            assert coords is not None, "åº§æ¨™èª­ã¿è¾¼ã¿ã«å¤±æ•—"
            print("âœ… åº§æ¨™èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆå®Œäº†")
            
            # Mermaidå›³ç”Ÿæˆãƒ†ã‚¹ãƒˆ
            print("ğŸ“‹ 3. Mermaidå›³ç”Ÿæˆãƒ†ã‚¹ãƒˆ...")
            test_question = "ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„"
            
            # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ†ã‚¹ãƒˆç”¨ã®Mermaidå›³ã‚’ä½¿ç”¨
            if automation.offline_mode:
                mermaid_code = """graph TD
    A[ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ] --> B[è¨­è¨ˆæ¤œè¨]
    B --> C[å®Ÿè£…é–‹å§‹]
    C --> D[ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ]
    D --> E[å®Œäº†]"""
                print("ğŸ”§ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ†ã‚¹ãƒˆMermaidå›³ã‚’ä½¿ç”¨")
            else:
                mermaid_code = automation.generate_dynamic_mermaid_diagram(test_question)
            
            assert mermaid_code and ("graph TD" in mermaid_code or "graph" in mermaid_code), "Mermaidå›³ç”Ÿæˆã«å¤±æ•—"
            print("âœ… Mermaidå›³ç”Ÿæˆãƒ†ã‚¹ãƒˆå®Œäº†")
            
            # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ
            print("ğŸ“‹ 4. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ...")
            automation.local_test_mode()
            print("âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å®Œäº†")
            
            print("ğŸ‰ Copilotè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆãŒå…¨ã¦å®Œäº†ã—ã¾ã—ãŸï¼")
            
        except Exception as e:
            print(f"âŒ Copilotãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {e}")
            import traceback
            traceback.print_exc()
    
    def run_unit_tests(self):
        """å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
        print("ğŸ”§ å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...")
        
        # pytestã‚’ä½¿ç”¨ã—ã¦å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        import subprocess
        
        test_files = [
            "tests/Python/test_knowledge_system.py",
            "tests/Python/test_mermaid_generation.py",
            "tests/Python/test_wiki_integration.py"
        ]
        
        for test_file in test_files:
            if os.path.exists(test_file):
                print(f"ğŸ“‹ {test_file} ã‚’å®Ÿè¡Œä¸­...")
                result = subprocess.run([sys.executable, "-m", "pytest", test_file, "-v"], 
                                      capture_output=True, text=True)
                if result.returncode == 0:
                    print(f"âœ… {test_file} å®Œäº†")
                else:
                    print(f"âŒ {test_file} å¤±æ•—")
                    print(result.stdout)
                    print(result.stderr)
    
    def run_feature_tests(self):
        """æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
        print("ğŸš€ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...")
        
        # FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ
        import subprocess
        
        feature_tests = [
            "test_automation_pytest.py",
            "test_fastapi_supabase_integration.py"
        ]
        
        for test_file in feature_tests:
            if os.path.exists(test_file):
                print(f"ğŸ“‹ {test_file} ã‚’å®Ÿè¡Œä¸­...")
                result = subprocess.run([sys.executable, "-m", "pytest", test_file, "-v"], 
                                      capture_output=True, text=True)
                if result.returncode == 0:
                    print(f"âœ… {test_file} å®Œäº†")
                else:
                    print(f"âŒ {test_file} å¤±æ•—")
                    print(result.stdout)
                    print(result.stderr)
    
    def run_all_tests(self):
        """å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
        print("ğŸŒŸ å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...")
        self.test_copilot_automation()
        self.run_unit_tests()
        self.run_feature_tests()

class FastAPITestCommand(ArtisanCommand):
    """FastAPIãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, action="start", *args, **kwargs):
        """FastAPIãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
        
        if action == "start":
            self.start_fastapi_server()
        elif action == "test":
            self.test_fastapi_endpoints()
        elif action == "integration":
            self.test_integration()
        else:
            print("ğŸš€ FastAPIçµ±åˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...")
            self.start_fastapi_server()
            time.sleep(3)
            self.test_fastapi_endpoints()
    
    def start_fastapi_server(self):
        """FastAPIã‚µãƒ¼ãƒãƒ¼èµ·å‹•"""
        print("ğŸŒ FastAPIã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­...")
        
        import subprocess
        import threading
        
        def run_server():
            subprocess.run([sys.executable, "app.py"], cwd=self.project_root)
        
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
        server_thread = threading.Thread(target=run_server, daemon=True)
        server_thread.start()
        
        print("âœ… FastAPIã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ (ãƒãƒ¼ãƒˆ: 8000)")
        print("ğŸŒ http://localhost:8000 ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½")
    
    def test_fastapi_endpoints(self):
        """FastAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ"""
        print("ğŸ“¡ FastAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆä¸­...")
        
        import requests
        import time
        
        base_url = "http://localhost:8000"
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        try:
            response = requests.get(f"{base_url}/")
            if response.status_code == 200:
                print("âœ… ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (/): OK")
            else:
                print(f"âŒ ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (/): {response.status_code}")
        except requests.exceptions.RequestException as e:
            print(f"âŒ ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")
        
        # è‡ªå‹•åŒ–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
        try:
            test_data = {"message": "ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "user": "test_user"}
            response = requests.post(f"{base_url}/automation/trigger", json=test_data)
            
            if response.status_code == 200:
                print("âœ… è‡ªå‹•åŒ–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (/automation/trigger): OK")
            else:
                print(f"âŒ è‡ªå‹•åŒ–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: {response.status_code}")
        except requests.exceptions.RequestException as e:
            print(f"âŒ è‡ªå‹•åŒ–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")
    
    def test_integration(self):
        """çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
        print("ğŸ”„ çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...")
        
        # Copilotè‡ªå‹•åŒ– + FastAPI + Supabaseçµ±åˆãƒ†ã‚¹ãƒˆ
        self.start_fastapi_server()
        time.sleep(5)
        self.test_fastapi_endpoints()
        
        # Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
        try:
            from supabase import create_client
            
            supabase_url = os.getenv('SUPABASE_URL')
            supabase_key = os.getenv('SUPABASE_KEY')
            
            if supabase_url and supabase_key:
                supabase = create_client(supabase_url, supabase_key)
                
                # ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒªå®Ÿè¡Œ
                result = supabase.table('chat_history').select('*').limit(1).execute()
                
                if result.data is not None:
                    print("âœ… Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ: OK")
                else:
                    print("âŒ Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ: ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—")
            else:
                print("âš ï¸ Supabaseè¨­å®šãŒä¸å®Œå…¨")
                
        except Exception as e:
            print(f"âŒ Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")

def main():
    """Artisanãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(
        description='ğŸ¨ Artisan - Laravelé¢¨ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ« for Python',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:
  route:list              ãƒ«ãƒ¼ãƒˆä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆå…¨ã¦ï¼‰
  route:active            ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ«ãƒ¼ãƒˆã®ã¿è¡¨ç¤º
  make:controller <n>     ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œæˆ
  make:model <n>          ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ
  make:migration <n>      ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
  gradio:test             Gradioæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ
  gradio:list             Gradioæ©Ÿèƒ½ä¸€è¦§ã‚’è¡¨ç¤º
  test [type]             ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (all/unit/feature/copilot)
  test:copilot            Copilotè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
  test:unit               ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:feature            æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  fastapi:test [action]   FastAPIãƒ†ã‚¹ãƒˆ (start/integration)
  fastapi:start           FastAPIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
  fastapi:integration     FastAPIçµ±åˆãƒ†ã‚¹ãƒˆ
  cicd [action]           CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
  
ä¾‹:
  python artisan route:list
  python artisan make:controller UserController
  python artisan test:copilot
  python artisan fastapi:start
  python artisan gradio:test --fix
        """
    )
    
    parser.add_argument('command', nargs='?', help='å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰')
    parser.add_argument('name', nargs='?', help='ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹å')
    parser.add_argument('--fix', action='store_true', help='ã‚¨ãƒ©ãƒ¼ã®è‡ªå‹•ä¿®æ­£ã‚’è©¦è¡Œ')
    parser.add_argument('--verbose', '-v', action='store_true', help='è©³ç´°å‡ºåŠ›')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    try:
        if args.command == 'route:list':
            RouteListCommand().handle()
            
        elif args.command == 'route:active':
            ActiveRouteListCommand().handle()
            
        elif args.command == 'make:controller':
            if not args.name:
                print("âŒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼åã‚’æŒ‡å®šã—ã¦ãã ã•ã„")
                print("ä¾‹: python artisan make:controller UserController")
                return
            MakeControllerCommand().handle(args.name)
            
        elif args.command == 'make:model':
            if not args.name:
                print("âŒ ãƒ¢ãƒ‡ãƒ«åã‚’æŒ‡å®šã—ã¦ãã ã•ã„")
                print("ä¾‹: python artisan make:model User")
                return
            MakeModelCommand().handle(args.name)
            
        elif args.command == 'make:migration':
            if not args.name:
                print("âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã‚’æŒ‡å®šã—ã¦ãã ã•ã„")
                print("ä¾‹: python artisan make:migration create_users_table")
                return
            MakeMigrationCommand().handle(args.name)
            
        elif args.command == 'cicd':
            action = args.name if args.name else "test"
            CICDCommand().handle(action, verbose=args.verbose)
            
        elif args.command == 'gradio:test':
            GradioTestCommand().handle(fix=args.fix, verbose=args.verbose)
            
        elif args.command == 'gradio:list':
            GradioListCommand().handle()
            
        elif args.command == 'test':
            test_type = args.name if args.name else "all"
            TestCommand().handle(test_type)
            
        elif args.command == 'test:copilot':
            TestCommand().handle("copilot")
            
        elif args.command == 'test:unit':
            TestCommand().handle("unit")
            
        elif args.command == 'test:feature':
            TestCommand().handle("feature")
            
        elif args.command == 'fastapi:test':
            action = args.name if args.name else "start"
            FastAPITestCommand().handle(action)
            
        elif args.command == 'fastapi:start':
            FastAPITestCommand().handle("start")
            
        elif args.command == 'fastapi:integration':
            FastAPITestCommand().handle("integration")
            
        else:
            print(f"âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: {args.command}")
            parser.print_help()
            
    except Exception as e:
        print(f"âŒ ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        if args.verbose:
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    main()